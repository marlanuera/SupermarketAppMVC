<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - SunnySide Market</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap">

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency %>"></script>

  <style>
    body { background-color: #FFFBEA; font-family: Arial, sans-serif; margin:0; }

    /* Navbar */
    nav.navbar { background-color: #2E8B57 !important; }
    nav .navbar-brand { font-family: 'Pacifico', cursive; font-size: 1.8rem; color: white !important; }
    nav .nav-link { color: white !important; font-weight: bold; }
    nav .nav-link:hover { background-color: #FFD54F; color: black !important; border-radius: 5px; }

    /* Page titles */
    .checkout-title { text-align:center; font-size:28px; color:#2E8B57; margin:20px 0 5px; font-weight:bold; }
    .checkout-sub { text-align:center; font-size:14px; color:#6b6b6b; margin-bottom:10px; }
    .checkout-underline { width:70px; height:3px; background:#FFA500; margin:0 auto 25px; border-radius:99px; }

    /* Container */
    .checkout-container { max-width: 1100px; margin:0 auto; padding:0 20px 40px; display:grid; grid-template-columns: 1.6fr 1.4fr; gap:30px; }
    @media (max-width:992px){ .checkout-container { grid-template-columns: 1fr; } }

    /* Cards */
    .card-summary, .card-delivery, .card-paypal { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.05); border:1px solid #eee; margin-bottom:20px; font-size:14px; }
    .card-title { font-size:18px; color:#2E8B57; display:flex; align-items:center; gap:10px; margin-bottom:12px; font-weight:bold; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:#FFF5E1; border:1px solid #FFE2A6; border-radius:999px; font-size:12px; color:#7a5a00; font-weight: normal; }

    /* Inputs */
    .hb-input { border-radius:12px; border:1px solid #eee; padding:10px 12px; font-size:14px; width:100%; }
    .hb-input:focus { border-color:#FFA500; box-shadow:0 0 0 0.15rem rgba(255,165,0,0.2); outline:none; }
    .hb-label { font-size:13px; font-weight:700; color:#5a5a5a; margin-bottom:6px; }
    .hb-note { font-size:12px; color:#7a7a7a; margin-top:10px; }

    /* Summary lines */
    .summary-line { display:flex; justify-content:space-between; color:#5a5a5a; margin:5px 0; }
    .summary-total { display:flex; justify-content:space-between; font-weight:900; font-size:18px; color:#1f1f1f; margin-top:10px; }
    .summary-total span:last-child{ color:#FFA500; font-size:20px; }

    /* Buttons */
    .hb-btn { padding:10px 16px; background:#FFA500; color:white; border:none; border-radius:20px; font-weight:700; display:inline-flex; align-items:center; gap:6px; justify-content:center; cursor:pointer; text-decoration:none; }
    .hb-btn:hover{ filter:brightness(0.97); }
    .hb-btn-outline { background:white; color:#FFA500; border:1px solid #FFA500; }
    .hb-btn-compact { padding:7px 12px; font-size:13px; border-radius:16px; }
    .wallet-meta { font-size:15px; font-weight:700; color:#2E8B57; }

    /* Tables */
    table.cart-table { background:white; border-radius:12px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size:14px; display:block; max-height:300px; overflow-y:auto; table-layout: fixed; width:100%; }
    table.cart-table th, table.cart-table td { vertical-align:middle !important; text-align: center; width: 25%; }
    table.cart-table img { max-width:80px; height:auto; border-radius:6px; }

    /* PayPal */
    #paypal-button-container { margin-top:10px; }
    #paypal-status { font-size:13px; color:#555; margin-top:6px; }

    /* NETS QR placeholder */
    .qr-placeholder { height:120px; border:2px dashed #FFA500; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#FFA500; font-weight:bold; margin-top:15px; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <h2 class="checkout-title">Checkout</h2>
  <div class="checkout-sub">Fresh. Fast. Tasty.</div>
  <div class="checkout-underline"></div>

  <% if (!cart || cart.length === 0) { %>
    <div class="card-summary">
      <div class="alert alert-warning mb-0">Your cart is empty.</div>
      <div class="mt-3">
        <a href="/shopping" class="hb-btn hb-btn-outline"><i class="bi bi-arrow-left"></i> Back to Shopping</a>
      </div>
    </div>
  <% } else { %>

    <div class="checkout-container">

      <!-- LEFT COLUMN: Shipping Info -->
      <div style="display:flex; flex-direction:column; gap:20px;">
        <div class="card-delivery" style="flex:1; min-height:500px;">
          <div class="card-title"><i class="bi bi-geo-alt"></i> Shipping Information</div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="hb-label">First Name</div>
              <input class="hb-input" id="firstName" placeholder="First Name" value="<%= (user && user.firstName) || '' %>" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Last Name</div>
              <input class="hb-input" id="lastName" placeholder="Last Name" value="<%= (user && user.lastName) || '' %>" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Email</div>
              <input class="hb-input" id="shippingEmail" placeholder="you@example.com" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Contact Number</div>
              <input class="hb-input" id="shippingPhone" placeholder="8-digit SG number" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Building / Apartment Name (optional)</div>
              <input class="hb-input" id="buildingName" placeholder="e.g., Sunnyside Towers">
            </div>
            <div class="col-md-6">
              <div class="hb-label">Postal Code</div>
              <input class="hb-input" id="postalCode" placeholder="123456" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Apartment / Unit</div>
              <input class="hb-input" id="aptUnit" placeholder="Blk 123, #12-34" required>
            </div>
            <div class="col-12">
              <div class="hb-label">Street Address</div>
              <input class="hb-input" id="shippingAddress" placeholder="Street name, building" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">City</div>
              <input class="hb-input" id="city" placeholder="City" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">State / Region</div>
              <input class="hb-input" id="state" placeholder="State or Region" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Country</div>
              <input class="hb-input" id="country" placeholder="Country" required>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Delivery Date (optional)</div>
              <input class="hb-input" id="deliveryDate" type="date">
            </div>
            <div class="col-md-6">
              <div class="hb-label">Time Slot (optional)</div>
              <select class="hb-input" id="timeSlot">
                <option value="">Select a time slot</option>
                <option>9am - 12pm</option>
                <option>12pm - 3pm</option>
                <option>3pm - 6pm</option>
                <option>6pm - 9pm</option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="hb-label">Pickup Option (optional)</div>
              <select class="hb-input" id="pickupOption">
                <option value="">Delivery</option>
                <option>Self-collection</option>
              </select>
            </div>
            <div class="col-12">
              <div class="hb-label">Delivery Instructions (optional)</div>
              <textarea class="hb-input" id="deliveryInstructions" rows="2" placeholder="Leave at front desk, ring the bell twice, etc."></textarea>
            </div>
            <div class="col-12">
              <div class="hb-label">Additional Notes (optional)</div>
              <input class="hb-input" id="notes" placeholder="No onions, extra chili, etc.">
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <a href="/cart" class="hb-btn hb-btn-outline"><i class="bi bi-arrow-left"></i> Back to Cart</a>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:20px;">

        <!-- Order Summary -->
        <div class="card-summary">
          <div class="card-title"><i class="bi bi-bag"></i> Order Summary <span class="pill"><i class="bi bi-receipt"></i> <%= cart.length %> item(s)</span></div>
          <div class="table-responsive">
            <table class="table cart-table align-middle mb-0 text-center">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Qty</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <% cart.forEach(item => { %>
                  <tr>
                    <td>
                      <img src="/images/<%= item.image %>" alt="<%= item.productName %>"><br>
                      <strong><%= item.productName %></strong>
                    </td>
                    <td>$<%= item.price.toFixed(2) %></td>
                    <td><%= item.quantity %></td>
                    <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="summary-line"><span>Subtotal</span><span>$<%= subtotal.toFixed(2) %></span></div>
          <div class="summary-line"><span>Tax (9%)</span><span>$<%= tax.toFixed(2) %></span></div>
          <div class="summary-line"><span>Total</span><span>$<%= total.toFixed(2) %></span></div>
          <div class="summary-line"><span>Wallet Applied</span><span>-$<%= walletApplied.toFixed(2) %></span></div>
          <div class="summary-line"><span>Points Applied</span><span>-$<%= pointsDiscount.toFixed(2) %></span></div>
          <div class="summary-total"><span>Total</span><span>$<%= payableTotal.toFixed(2) %></span></div>
        </div>

        <!-- Sunnyside Wallet -->
        <div class="card-paypal">
          <div class="card-title"><i class="bi bi-wallet2"></i> Sunnyside Wallet</div>
          <div class="mb-2 wallet-meta">
            Balance: <strong>$<%= walletBalance.toFixed(2) %></strong>
          </div>
          <form action="/checkout/pay-wallet" method="POST">
            <button type="submit" class="hb-btn hb-btn-outline hb-btn-compact w-100"><i class="bi bi-wallet2"></i> Pay with Sunnyside Wallet</button>
          </form>
          <% if (walletError) { %>
            <div class="text-danger mt-2" style="font-size:12px;">Insufficient wallet balance. Please top up or use another payment method.</div>
            <script>
              alert('Insufficient wallet balance. Please top up or use another payment method.');
            </script>
          <% } %>
        </div>

        <!-- Points Rewards -->
        <div class="card-paypal">
          <div class="card-title"><i class="bi bi-gift"></i> Points Rewards <span class="pill">10 pts = $1</span></div>
          <div class="mb-2 wallet-meta">
            Points: <strong><%= pointsAvailable %></strong>
          </div>
          <div class="mb-2 text-muted" style="font-size:12px;">
            Redeemable now: <strong><%= maxPointsRedeemable %></strong> pts = $<%= (maxPointsRedeemable * 0.10).toFixed(2) %>
          </div>
          <form action="/checkout/apply-rewards" method="POST" class="d-flex flex-column gap-2">
            <input type="hidden" name="walletUseAmount" value="0">
            <input type="hidden" name="pointsToRedeem" value="<%= maxPointsRedeemable %>">
            <button type="submit" class="hb-btn hb-btn-compact w-100" <%= maxPointsRedeemable > 0 ? '' : 'disabled' %>>
              <i class="bi bi-gift"></i> Redeem Points Reward
            </button>
          </form>
          <form action="/checkout/apply-rewards" method="POST" class="mt-2">
            <input type="hidden" name="walletUseAmount" value="0">
            <input type="hidden" name="pointsToRedeem" value="0">
            <button type="submit" class="hb-btn hb-btn-compact w-100">Clear Rewards</button>
          </form>
        </div>

        <% if (payableTotal > 0) { %>
        <!-- PayPal Payment -->
        <div class="card-paypal">
          <div class="card-title"><i class="bi bi-paypal"></i> Pay with PayPal <span class="pill"><i class="bi bi-shield-check"></i> secure</span></div>
          <div id="paypal-button-container"></div>
          <div id="paypal-status"></div>

          <script>
            const checkoutSubtotal = <%= subtotal.toFixed(2) %>;
            const checkoutTax = <%= tax.toFixed(2) %>;
            const checkoutTotal = <%= payableTotal.toFixed(2) %>;
            const checkoutDiscount = <%= (total - payableTotal).toFixed(2) %>;
            const checkoutItems = <%- JSON.stringify(cart || []) %>;

            function getShippingName() {
              const el = document.getElementById("firstName");
              return el ? (el.value || "").trim() : "";
            }

            paypal.Buttons({
              createOrder: async () => {
                const payload = {
                  items: checkoutItems,
                  subtotal: checkoutSubtotal,
                  tax: checkoutTax,
                  total: checkoutTotal,
                  discount: checkoutDiscount,
                  shippingName: getShippingName()
                };

                const res = await fetch("/paypal/create-order", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Failed to create PayPal order");
                return data.id;
              },

              onApprove: async (data) => {
                const res = await fetch("/paypal/capture-order", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ orderId: data.orderID })
                });

                const result = await res.json();
                if (!res.ok || !result.ok) throw new Error(result.error || "Payment capture failed");

                document.getElementById("paypal-status").innerText = "Payment completed! Redirecting...";
                window.location.href = '/payment-success?method=paypal';
              },

              onError: (err) => {
                console.error(err);
                document.getElementById("paypal-status").innerText = "PayPal error: " + (err?.message || "Unknown error");
              }
            }).render("#paypal-button-container");
          </script>
          <!-- ðŸ”½ NETS BUTTON (THIS IS THE ONLY NEW PART) -->
          <hr class="my-3">

          <div class="card-paypal">
            <div class="card-title"><i class="bi bi-qr-code-scan"></i> Pay with NETS QR <span class="pill"><i class="bi bi-shield-check"></i> secure</span></div>
            <form action="/generateNETSQR" method="POST">
              <input type="hidden" name="cartTotal" value="<%= payableTotal.toFixed(2) %>">
              <button type="submit" class="hb-btn hb-btn-outline w-100">
                <i class="bi bi-qr-code-scan"></i>
                Pay with NETS QR
              </button>
            </form>
            <p class="text-muted text-center mt-2" style="font-size:12px;">
              You will be redirected to scan the NETS QR code
            </p>
          </div>
          <div class="card-paypal mt-3">
            <div class="card-title"><i class="bi bi-credit-card-2-front"></i> Pay with Stripe <span class="pill"><i class="bi bi-shield-check"></i> secure</span></div>
            <button id="stripe-pay-button" class="hb-btn w-100">
              <i class="bi bi-credit-card-2-front"></i> Pay with Stripe
            </button>
          </div>

          <script src="https://js.stripe.com/v3/"></script>
          <script>
          const stripe = Stripe('<%= process.env.STRIPE_PUBLISHABLE_KEY %>'); // pk_test_...
          document.getElementById('stripe-pay-button').addEventListener('click', async () => {
            const res = await fetch('/stripe/create-checkout-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (data.id) {
              stripe.redirectToCheckout({ sessionId: data.id });
            } else {
              alert('Stripe checkout failed');
            }
          });
          </script>


        </div>
        <% } else { %>
        <div class="card-paypal">
          <div class="card-title"><i class="bi bi-check-circle"></i> Wallet Covers Total</div>
          <p class="text-muted mb-2" style="font-size:12px;">Your Sunnyside Wallet + points cover the full amount. Complete checkout with wallet.</p>
          <form action="/checkout/complete-wallet" method="POST">
            <button type="submit" class="hb-btn w-100"><i class="bi bi-wallet2"></i> Complete with Wallet</button>
          </form>
        </div>
        <% } %>

      </div>

    </div>
  <% } %>
</body>
</html>









